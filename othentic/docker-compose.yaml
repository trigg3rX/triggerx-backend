x-otnode: &otnode
  env_file:
    - .env
  build:
    context: .
    dockerfile: ./Dockerfile

services:
  aggregator:
    container_name: aggregator
    <<: *otnode
    env_file:
      - .env
    command: [
      "run",
      "aggregator",
      "--json-rpc",
      "--json-rpc.port", "${AGGREGATOR_RPC_PORT}",
      "--json-rpc.custom-message-enabled",
      "--p2p.port", "${AGGREGATOR_P2P_PORT}",
      "--p2p.datadir", "/peerstore/aggregator",
      "--p2p.discovery-interval", "${AGGREGATOR_P2P_DISCOVERY_INTERVAL}",
      "--p2p.public-ip", "${PUBLIC_IPV4_ADDRESS}",
      "--internal-tasks",
      "--l1-chain", "mainnet",
      "--l2-chain", "base",
      "--delay", "10000",
      "--keystore", "/keystore/aggregator.json",
      "--keystore-password", ""
    ]
    environment:
      - BLS_PRIVATE_KEY=${PRIVATE_KEY_AGGREGATOR}
      - L1_RPC=${L1_RPC}
      - L2_RPC=${L2_RPC}
      - INTERNAL_TASKS=${INTERNAL_TASKS}
      - AVS_GOVERNANCE_ADDRESS=${AVS_GOVERNANCE_ADDRESS}
      - ATTESTATION_CENTER_ADDRESS=${ATTESTATION_CENTER_ADDRESS}
      - OTHENTIC_BOOTSTRAP_ID=${OTHENTIC_BOOTSTRAP_ID}
      - OTHENTIC_BOOTSTRAP_SEED=${OTHENTIC_BOOTSTRAP_SEED}
      - PUBLIC_IPV4_ADDRESS=${PUBLIC_IPV4_ADDRESS}
      - LOG_DIR=${LOG_DIR_AGGREGATOR}
      - AGGREGATOR_RPC_PORT=${AGGREGATOR_RPC_PORT}
      - AGGREGATOR_P2P_PORT=${AGGREGATOR_P2P_PORT}
      - AGGREGATOR_P2P_DISCOVERY_INTERVAL=${AGGREGATOR_P2P_DISCOVERY_INTERVAL}
      - AGGREGATOR_METRICS_PORT=${AGGREGATOR_METRICS_PORT}
    volumes:
      - ./data/peerstore/aggregator:/peeerstore/aggregator
      - ./data/logs/aggregator:/data/logs/aggregator
      - ./.keystore:/keystore
    ports:
      - "${AGGREGATOR_P2P_PORT}:${AGGREGATOR_P2P_PORT}"
      - "${AGGREGATOR_RPC_PORT}:${AGGREGATOR_RPC_PORT}"
    networks:
      p2p:
        ipv4_address: 172.28.0.69

networks:
  p2p:
    driver: bridge
    ipam:
     config:
       - subnet: 172.28.0.0/16
         gateway: 172.28.0.1
